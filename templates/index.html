<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <link rel="icon" type="image/x-icon" href="/static/wmuclogo1.png">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='index.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <title>WMUSee</title>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light" style="padding-left: 20px; padding-right: 20px;">
        <a class="navbar-brand" href="/">
            <img class="logo" src="{{ url_for('static', filename='wmuseefinal.png') }}" width="40%" height="40%">
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
    
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="/">Create</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/search">Search</a>
                </li>
            </ul>
        </div>
    </nav>
      
    <div class="container">
        <h1 style="padding-top: 50px; padding-bottom: 15px;">CREATE NEW TRANSCRIPT</h1>
        <hr style="padding-bottom: 30px;">
        <form id="mainform">
            <div class="form-group">
              <label for="djs">DJ(s)</label>
              <input type="text" class="form-control" id="djs" placeholder="DJ Testudo">
            </div>
            <div class="form-group" style="padding-bottom: 25px;">
                <label for="showname">Show Name</label>
                <input type="text" class="form-control" id="showname" placeholder="Weezer Wednesday">
            </div>
            <button onclick="recordAudio()" id="recButton" class="notRec" type="button"></button>
            <div class="form-group" style="padding-top: 20px;">
              <label for="results">Press the button above to begin recording. Press again to stop</label>
              <button type="button" id="edit" class="btn btn-secondary" onclick="editTextArea()">Edit</button>
              <textarea class="form-control" id="results" rows="10" readonly></textarea>
            </div>
            <button type="button" onclick="upload()" class="btn btn-danger" style="min-width: 80px; margin-top: 30px;">Upload</button>
        </form>
    </div>
    <footer class="d-flex flex-wrap justify-content-between align-items-center py-3 my-4 border-top">
        <div class="col-md-4 d-flex align-items-center">
          <a href="/" class="mb-3 me-2 mb-md-0 text-body-secondary text-decoration-none lh-1">
            <svg class="bi" width="30" height="24"><use xlink:href="#bootstrap"></use></svg>
          </a>
          <span class="mb-3 mb-md-0 text-body-secondary">Developed by Vincent Strappelli</span>
        </div>
    
        <ul class="nav col-md-4 justify-content-end list-unstyled d-flex">
          <li class="ms-3"><a class="text-body-secondary" href="#"><svg class="bi" width="24" height="24"><use xlink:href="#twitter"></use></svg></a></li>
          <li class="ms-3"><a class="text-body-secondary" href="#"><svg class="bi" width="24" height="24"><use xlink:href="#instagram"></use></svg></a></li>
          <li class="ms-3"><a class="text-body-secondary" href="#"><svg class="bi" width="24" height="24"><use xlink:href="#facebook"></use></svg></a></li>
        </ul>
    </footer>
    <div id="myModal" class="modal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <p><strong>Login Info</strong></p>
          <label for="username">Username</label>
          <input type="text" class="form-control" id="username">
          <label for="password">Password</label>
          <input type="text" class="form-control" id="password">
          <button type="button" id="login" class="btn btn-primary" style="min-width: 80px; margin-top: 30px;" onclick="authenticate()">Login</button>
        </div>
    </div>
</body>
</html>

<script>
    let listening = false
    let modal = document.getElementById("myModal");
    let exbox = document.getElementsByClassName("close")[0];

    async function recordAudio() {

        if (listening == false) {
            listening = true
            $('#recButton').removeClass('notRec')
            $('#recButton').addClass('Rec')
        } else {
            listening = false
            $('#recButton').removeClass('Rec')
            $('#recButton').addClass('notRec')
        }
        while (listening == true) {
            try {
                const response = await fetch('/api/listen', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                let data = await response.json()
                let res = document.getElementById("results")
                let newText = document.createTextNode(data.results)
                res.appendChild(newText)
            } catch (error) {
                console.error('There was a problem with the fetch operation:', error);
            }
        }
    }

    function upload() {
        const djs = document.getElementById("djs");
        const showname = document.getElementById("showname");
        if (djs.value == "" || showname.value == "") {
            alert("Must enter DJ(s) and Show Name")
        } else {
            modal.style.display = "block"
        }
    }

    function editTextArea() {
        const txtArea = document.getElementById("results");
        if (txtArea.hasAttribute("readonly")) {
            txtArea.removeAttribute("readonly");
        } else {
            txtArea.setAttribute("readonly", "true");
        }
    }

    exbox.onclick = function() {
        modal.style.display = "none"
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none"
        }
    }

    async function authenticate() {
        username = document.getElementById("username").value
        password = document.getElementById("password").value
        try {
            const response = await fetch('/api/authenticate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user: username, pass: password })
            });
            let data = await response.json()
            if (data.result == "Success") {
                insert()
            } else {
                alert("failure")
            }
            modal.style.display = "none"
        } catch (error) {
            console.error('There was a problem with the fetch operation:', error);
        }
    }

    async function insert() {
        let djs = document.getElementById("djs").value
        let showname = document.getElementById("showname").value
        let results = document.getElementById("results").value
        try {
            const response = await fetch('/api/insert', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ speakers: djs, shownm: showname, txt: results })
            });
            let data = await response.json()
            let res = data.results
            alert(res)
        } catch (error) {
            console.error('There was a problem with the fetch operation:', error);
        }
    }
</script>